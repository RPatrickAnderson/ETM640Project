---
title: "ETM640ProjectDraft"
author: "Randolph Anderson"
date: "March 4, 2019"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
The 532d Training Squadron (532 TRS) is a unit in the United States Air Force (USAF).  The 532 TRS
trains the nation's intercontinental ballistic missile (ICBM) operators. The unit also trains
maintenance forces for ICBM and air launched cruise missile (ALCM) systems. 532 TRS instructors
receive professional development (ProD) to increase their knowledge of nuclear enterprise.  
Professional development involves sending one or more nstructors on a trip to a nuclear facility 
in the United States.While on their trip, instructors receive tours and briefings from onsite personnel.
One purpose of providing professional development is to increase effectiveness of instructors. Instructors
can help motivate students by illuminating the importance of what students are learning.  However,
instructors also perform jobs that do not involve actively teaching students.  When in these other
jobs instructors are not in the best position to integrate what they learned into their instruction.

## Problem Definition
Some instructors do not receive professional development until most of their instructing time is
over.  As a result, they never get a chance to share what they have learned with the students.
Since the goal of ProD is, in part, to increase the effectiveness of instructors, the unit may be
able to do a better job assigning instructors to professional development trip in a way that
balances several objectives (goals).

## Objectives/Goals
The squadron has several objectives for the professional development program.  Objectives
include:

1. (Budget) ProD budget should fully utilize remaining travel funds after all mission required
trips are funded; ProD Budget = Total Budget - Mission Required Trips Costs.

2. (Improve Instruction) ProD should help instructors be more effective teaching.

3. (Fair development of instructor core) Each instructor is to be given the opportunity to go on at 
least one ProD trip per year and there should a limit on the max number of trips a person goes on.

4. (Merit):  Instructors merit is considered when assigning instructors to ProD opportunities
that are tagged as being a "glory trip".  A glory trip is does something that is extra special.
The idea is to reward high performing instructors with a special trip.

## Goal Programming Model
Goal programming is an optimization techniques to solve problems with multiple objectives.  
Additionally, Goal programming allows for flexibility in meeting constraints by allowing constraints
to be deviated/broken in order to balance multiple goals.  The model will determine which instructor to 
send on which ProD trip for each quarter (3 month period). Goal programming models can be formulated
in many different ways. For example, some models might aim to minimized the sum of deviations from the goal 
targets, while other models, may be set up to minimize the largest deviation (minimax model). This 
project will use a version of the minimax model. A weighted percentage based minimax model is selected for the 
following reasons and assumptions. It is assumed that harm from deviations may increase rapidly such
that it may not be advantage to allow one goal to float to far from target. For example, if objective 3 was 
allowed to deviate it could create harmful perceptions of unfairness. The percentage based minimax
model was selected because harm of deviation was assumed to be more closely related to percentage deviation
then nominal deviation. Weights were applied because squadron leadership has communicated that a loose
prioritization between the goals. Weights will allow the model to capture these priorities into 
the results.

##Decision Variables
There are j instructors and i ProD trips. The model aims to determine which instructors to send on which trip. For each instructor a decision is made to either send or don't send for each trip. To capture all this decisions a discison matrix is defined. $DV[i,j]$ captures the decision for each instructor trip combination. Each element of the matrix is either a 0 or a 1. A 0 indicates that the jth instructor was not assigned to the ith trip. While a 1 indicates that the jth intructor is assigned to the ith trip. For example, DV[1,2]=1 indicates the decision to send instructor 2 to Pro-D trip 1. While DV[12,34] =0 indicates that the 34th instructor is not assigned to 12th trip.

## Objective 
Min: Q, Where Q is less than or equal to the weighted ratio of goal related deviations (e.g Q <= (weight)*Deviation/GoalTarget)

```{r}
suppressPackageStartupMessages(library(ompr.roi))
suppressPackageStartupMessages(library(ROI.plugin.glpk))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ggrepel))
suppressPackageStartupMessages(library (magrittr, quietly = TRUE))     #Used for pipes/dplyr
suppressPackageStartupMessages(library (pander, quietly = TRUE))       # for nicely formated tables
suppressPackageStartupMessages(library(dplyr, quietly=TRUE))           # For data structure manipulation
suppressPackageStartupMessages(library(ROI, quietly=TRUE))             # R Optimization Interface package
suppressPackageStartupMessages(library(ROI.plugin.glpk, quietly=TRUE)) # Connection to glpk as solver
suppressPackageStartupMessages(library(ompr, quietly=TRUE))            # Optimization Modeling using R
suppressPackageStartupMessages(library(ompr.roi, quietly=TRUE))        # Connective tissue
suppressPackageStartupMessages(library(tidyr))
```

## Data Input
```{r Instructor Data}
# reads in the instructor data from a csv file.
RawInstructorData <- as.matrix(read.table(file="InstructorData.csv", row.names=1,sep=","))
colnames(RawInstructorData) <- c("Instructor","DAID", "4QHrs", "Top Performer","Active/Inactive")
RawInstructorData
```

```{r Trip Data}
# reads in the instructor data from a csv file.
RawTripData <- as.matrix(read.table(file="C:/Users/rpatr/Documents/ProDTripData.csv", row.names=1,sep=","))
colnames(RawTripData) <- c("Trip Name","MeritBased", "Cost/Instr", "instrSlotsAvailable","NumberOfDays","TotalCost")
RawTripData
```

```{r}
TotalTravelBudget <- 188000 #budget for all unit funded travel. This is a hard limit. 
MissionTravelCosts <- 0 #(ssumes no mission related trips accomplished prior to model being run. 
ForcastedMissionTravelCosts <- 125000 #current mission related travel forcasted by resource advisor
ProDTravelCosts <- 0  #(assumes no ProD trips accomplished prior to model being run.
TotalRemainingTravelBudget <- 188000-MissionTravelCosts-ProDTravelCosts
ProDTripBudgetTarget <- .9*(TotalTravelBudget-ForcastedMissionTravelCosts) # Target is to use 90% of open funds
NumOfTrips <- length(RawTripData[,1])
NumOfInstructors <- length(RawInstructorData[,1])
TDYCostPerPerson <- as.numeric(RawTripData[,3])
InstructorStatus <- as.numeric(RawInstructorData[,5])
InstructorMerit <-  as.numeric(RawInstructorData[,4])
TripMeritStatus <-  as.numeric(RawTripData[,2])
ProDTripForActiveInstructorCoefficient <- 2 # goal is for active to aim to go on 2 trips per year
TotalNumOfProDTripsForActiveInstructorsTarget <-
  ProDTripForActiveInstructorCoefficient*tabulate(as.numeric(RawInstructorData[,5]),nbins = 1)
#Calc the TargetNumOfInstructorsToSendOnMeritTrips
InstrSlotsAvailable <- as.numeric(RawTripData[,4])
NumOfMeritTripsSlotsAvailable <- TripMeritStatus %*% InstrSlotsAvailable
NumOfInstructorsWithMeritStatus <- tabulate(as.numeric(RawInstructorData[,4]),nbins = 1)
TargetNumOfInstructorsToSendOnMeritTrips <- min(NumOfInstructorsWithMeritStatus,NumOfMeritTripsSlotsAvailable)
MiniumTripsTarget <- 1 # Target is to send each instructor on at least 1 Pro-D a year minium
MaxTripsTarget <- 3 # Target is to send each instructor on at least 1 Pro-D a year minium
Weights <- as.matrix(c(1,1,1,1,1))
```

## Goal Programming Code
```{r MIP Code}

model <- MIPModel() %>%
  
  # VARIABLES
  add_variable(Q, type = "continuous",  lb = 0) %>%
  add_variable (DV[i, j], i=1:NumOfTrips, j=1:NumOfInstructors, type="binary") %>%
  add_variable(BDminus, type = "continuous", lb = 0) %>%
  add_variable(BDpostive, type = "continuous", lb = 0) %>%
  add_variable(IDminus, type = "integer", lb = 0) %>%
  add_variable(IDpostive, type = "integer", lb = 0) %>%
  add_variable (MinTDminus[j], j=1:NumOfInstructors, type="integer", lb=0) %>% 
  add_variable (MinTDpostive[j], j=1:NumOfInstructors, type="integer", lb=0) %>%
  add_variable (MaxTDminus[j], j=1:NumOfInstructors, type="integer", lb=0) %>% 
  add_variable (MaxTDpostive[j], j=1:NumOfInstructors, type="integer", lb=0) %>% 
  add_variable(MDminus, type = "integer", lb = 0) %>%
  add_variable(MDpostive, type = "integer", lb = 0) %>%
  
  # OBJECTIVE
  ##Minimize the weighted sum of % deviations (see objective constraints below)
  set_objective(Q, "min") %>%
  
  # GOAL CONSTRAINTS
  ## 1. ProD Trip Budget Goal
  add_constraint((sum_expr(TDYCostPerPerson[i]*DV[i,j],i=1:NumOfTrips, j=1:NumOfInstructors)) + BDminus - BDpostive
                 == ProDTripBudgetTarget)%>%
  ## 2. Improve instruction Goal
  add_constraint((sum_expr(InstructorStatus[j]*DV[i,j],i=1:NumOfTrips, j=1:NumOfInstructors)) + IDminus - IDpostive
                 == TotalNumOfProDTripsForActiveInstructorsTarget)%>%
  ## 3. Fairly Develop Instructors: Minimum Trips
  add_constraint(sum_expr(DV[i,j],i=1:NumOfTrips) + MinTDminus[j] - MinTDpostive[j] ==
                   MiniumTripsTarget,j=1:NumOfInstructors)%>%
  ## 4. Fairly Develop Instructors: Max Trips
  add_constraint(sum_expr(DV[i,j],i=1:NumOfTrips)+ MaxTDminus[j] - MaxTDpostive[j] ==
                   MaxTripsTarget,j=1:NumOfInstructors)%>%
  ## 5. Instructor Merit
  add_constraint((sum_expr(InstructorMerit[j]*TripMeritStatus[i]*DV[i,j],i=1:NumOfTrips, j=1:NumOfInstructors)) +
                   MDminus - MDpostive == TargetNumOfInstructorsToSendOnMeritTrips)%>%
  
  # HARD CONSTRAINTS
  ## 1. Budget Constraint
  add_constraint(sum_expr(TDYCostPerPerson[i]*DV[i,j],i=1:NumOfTrips, j=1:NumOfInstructors) <=
                   TotalRemainingTravelBudget)%>%
  ## 2. Slots Open for Trip
  add_constraint(sum_expr(DV[i,j], j=1:NumOfInstructors) <= InstrSlotsAvailable[i], i=1:NumOfTrips)%>%
  
  # OBJECTIVE CONSTRAINTS
  ## 1. Budget 
  add_constraint(Weights[1]*(BDminus + BDpostive)/ProDTripBudgetTarget <= Q) %>%
  ## 2. Improve Instruction
  add_constraint(Weights[2]*(IDminus + IDpostive)/TotalNumOfProDTripsForActiveInstructorsTarget <= Q) %>%
  ## 3. Fairly Develop Instructors (min Trips target)
  add_constraint(Weights[3]*(MinTDminus[j] + MinTDpostive[j])/MiniumTripsTarget <= Q, j=1:NumOfInstructors) %>%
  ## 4. Fairly Develop Instructors (max Trips Target)
  add_constraint(Weights[4]*(MaxTDminus[j] + MaxTDpostive[j])/MaxTripsTarget <= Q, j=1:NumOfInstructors) %>%
  ## 5. Instructor Merit
  add_constraint(Weights[5]*(MDminus + MDpostive)/TargetNumOfInstructorsToSendOnMeritTrips <= Q)


result <- solve_model(model, with_ROI(solver = "glpk", verbose = TRUE))

```


